#!/bin/bash

START_HOUR=21
END_HOUR=7
START_K=6500
END_K=3000

current_total_min=$((10#$(date +%H) * 60 + 10#$(date +%M)))
start_total_min=$((START_HOUR * 60))
end_total_min=$((END_HOUR * 60))

pkill gammastep
gammastep -x &
pkill gammastep

[ -f /tmp/noautored ] && exit 0

if [[ $1 != "" ]]; then
    gammastep -PO "$1"
    exit 0
fi

duration=$(( (end_total_min - start_total_min + 1440) % 1440 ))
elapsed=$(( (current_total_min - start_total_min + 1440) % 1440 ))

if [ "$elapsed" -ge "$duration" ]; then
    pkill gammastep
else
    diff=$((START_K - END_K))
    reduction=$(( (diff * elapsed) / duration ))
    target_k=$((START_K - reduction))

    gammastep -PO "$target_k"
fi
